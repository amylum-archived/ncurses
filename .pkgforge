name 'ncurses'
org 'amylum'

license 'COPYING'

source(
  type: 'tar',
  url: 'https://invisible-mirror.net/archives/ncurses/current/ncurses-6.1-20190309.tgz',
  checksum: '149356c144b5f5b45357b3fa1e5f45a6738ed8778bde12cbaac5bda576fea1c8'
)

configure_flags(
  prefix: '/usr',
  'with-termlib': 'tinfo',
  'with-ticlib': 'tic',
  'with-shared': nil,
  'with-normal': nil,
  'without-cxx': nil,
  'without-cxx-binding': nil,
  'enable-widec': nil
)

harden

build do
  configure
  make
  install

  def lib_link(lib, target)
    file = "#{releasedir}/usr/lib/lib#{lib}.so"
    File.open(file, 'w') { |fh| fh << "INPUT(#{target})" }
  end

  %w(ncurses form panel menu).each { |lib| lib_link(lib, "-l#{lib}w") }

  lib_link('cursesw', '-lncursesw')
  run "ln -s libncurses.so #{releasedir}/usr/lib/libcurses.so"

  rm "usr/lib/libncursesw.so"
  lib_link('ncursesw', 'libncursesw.so.6 -ltinfo')
end

test do
  run 'ncursesw6-config --version'
end
